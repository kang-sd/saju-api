

def calculate_hour_stem_branch(birthtime, day_gan):
    # 시지 구간 정의 (정시 기준 2시간 단위)
    hour_to_branch = {
        (23, 0): '자', (1, 2): '축', (3, 4): '인', (5, 6): '묘',
        (7, 8): '진', (9, 10): '사', (11, 12): '오', (13, 14): '미',
        (15, 16): '신', (17, 18): '유', (19, 20): '술', (21, 22): '해'
    }

    # 천을귀인 시천간 매핑 (부분만 포함, 필요시 확장)
    hour_gan_map = {
        '갑': ['갑','을','병','정','무','기','경','신','임','계','갑','을'],
        '을': ['병','정','무','기','경','신','임','계','갑','을','병','정'],
        '병': ['무','기','경','신','임','계','갑','을','병','정','무','기'],
        '정': ['경','신','임','계','갑','을','병','정','무','기','경','신'],
        '무': ['임','계','갑','을','병','정','무','기','경','신','임','계'],
        '기': ['갑','을','병','정','무','기','경','신','임','계','갑','을'],
        '경': ['병','정','무','기','경','신','임','계','갑','을','병','정'],
        '신': ['무','기','경','신','임','계','갑','을','병','정','무','기'],
        '임': ['경','신','임','계','갑','을','병','정','무','기','경','신'],
        '계': ['임','계','갑','을','병','정','무','기','경','신','임','계'],
    }

    try:
        hour, minute = map(int, birthtime.strip().split(":"))

        # 30분 보정
        minute -= 30
        if minute < 0:
            minute += 60
            hour -= 1
        if hour < 0:
            hour = 23

        # 시지 판단
        for (start, end), branch in hour_to_branch.items():
            if hour in (start, end):
                hour_branch = branch
                break
        else:
            return "시지오류", "시지오류"

        # 시천간 계산
        day_gan_clean = day_gan[0]
        branch_order = ['자','축','인','묘','진','사','오','미','신','유','술','해']
        if day_gan_clean in hour_gan_map:
            idx = branch_order.index(hour_branch)
            hour_gan = hour_gan_map[day_gan_clean][idx]
        else:
            hour_gan = "일간오류"

        return hour_gan, hour_branch
    except:
        return "시간오류", "시간오류"
